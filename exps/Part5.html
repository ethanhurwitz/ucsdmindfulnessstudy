<!DOCTYPE html>
<html>
<head>
<title>SONA experiment</title>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <!-- <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script> -->
<!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="https://timbrady.org/turk/TimTurkTools.js"></script> -->
<script src="../jsLibs/jquery-3-6-0-min.js"></script>
<script src="../jsLibs/ajax.js"></script>
<script src="../jsLibs/bootstrap-min.js"></script>
<script src="../jsLibs/TimTurkTools.js"></script>
<script src="../jsPsych/jspsych-6.1.0/jspsych.js"></script>
<script src="../jsPsych/jspsych-6.1.0/plugins/jspsych-html-keyboard-response.js"></script>
<script src="../jsPsych/jspsych-6.1.0/plugins/jspsych-html-button-response.js"></script>
<script src="../jsPsych/jspsych-6.1.0/plugins/jspsych-image-keyboard-response.js"></script>
<script src="../jsPsych/jspsych-6.1.0/plugins/jspsych-survey-multi-choice.js"></script>
<script src="../jsPsych/jspsych-6.1.0/plugins/jspsych-survey-multi-select.js"></script>
<script src="../jsPsych/jspsych-6.1.0/plugins/jspsych-video-button-response.js"></script>
<script src="../jsPsych/jspsych-6.1.0/plugins/jspsych-survey-text.js"></script>
<script src="../jsPsych/jspsych-6.1.0/plugins/jspsych-free-sort_update2.js"></script>
<script src="../jsPsych/jspsych-6.1.0/plugins/jspsych-survey-html-form.js"></script>
<!--audio record 1-->
<script src="../jsPsych/jspsych-6.1.0/plugins/jspsych-html-audio-response_modified.js"></script>
<!--audio record 2-->
<script src="../jsPsych/jspsych-6.1.0/plugins/jspsych-html-audio-response.js"></script>
<!--link here-->
<link href="../jsPsych/jspsych-6.1.0/css/jspsych.css" rel="stylesheet" type="text/css"></link>

<style>
    .CDmask {
        height: 550px;
        width: 550px;
    }
    .CDimage {
        height: 500px;
        width: 500px;
    }

</style>
</head>
  
  <body>
    <script>

var randCode = "RAT" + Math.round(Math.random()*1000) + "420" + Math.round(Math.random()*1000);

Shuffle = function (o) {
    for (var j, x, i = o.length; i; j = parseInt(Math.random() * i), x = o[--i], o[i] = o[j], o[j] = x);
    return o;
};

var startTime = new Date();

var timeline = [];

var partID = {
  type: 'survey-text',
  questions: [
    {prompt: "Enter participant ID", name: 'partID', rows: 1, columns: 12, required: true}
  ],
  data: {
			type: "partID"}
};

timeline.push(partID);

// var consent = {
//   type: 'html-button-response',
//   stimulus: 'Please read the consent form below and click "I agree" below to consent and begin the study.'+
//   '<iframe src="../151866_AdultConsent_clean.pdf#toolbar=0" width="100%" height="500px">'+
//     '</iframe>',
//   choices: ["I agree"],
//   data: {exp: 'RAT',
//       type: "consent"}
// };

// timeline.push(consent);

// RAT TRIALS
// RAT TRIALS
// RAT TRIALS
// RAT TRIALS
// RAT TRIALS
// RAT TRIALS
// RAT TRIALS
// RAT TRIALS
// RAT TRIALS
// RAT TRIALS
// RAT TRIALS
// RAT TRIALS
// RAT TRIALS
// RAT TRIALS
// RAT TRIALS
// RAT TRIALS
// RAT TRIALS
// RAT TRIALS
ratTrials = [];

var introRAT = {
type: 'html-keyboard-response',
stimulus: "On each of the following pages, you will be shown 3 target words.<br>"+
"Your goal is to attempt to generate a fourth word which, when combined with <br><b>each of the three target words</b>, will result in word pairs that make up a common compound word or phrase.<br>"+
`Let's look at an example. For the target words:<br><br>`+
"cottage, swiss, cake<br><br>"+
`the 4th word would be <b>cheese</b>. This would create the word pairs 'cottage cheese,' 'swiss cheese,' and 'cheesecake.' <br><br>`+
"Here's how to play: we will be recording your responses, to make things easier for you.<br>"+
"All you have to do is think out loud while considering different options.<br>"+
'You will have <b>1 minute</b> for each trial. If you arrive at the answer before then, press the <b>SPACEBAR</b> to immediately proceed.<br>'+
"Only push the spacebar if you have arrived at your final answer and want to move on. YOU CANNOT GO BACK.<br>"+
"We will first start with a few training trials so you can get the hang of it.<br>"+
"You will have to grant the browser mic access. Be sure to click back to the center of the page after you click accept, otherwise the spacebar won't work!<br><br><br><br>",
choices: ['space'],
prompt: "<p>Press spacebar to continue</p>",
data: {exp: 'RAT',
  type: 'RAT_Instr'}
};

ratTrials.push(introRAT)

var wordTriads1 = [['chocolate', 'fortune', 'tin'],
['safety', 'cushion', 'point'],
['dust', 'cereal', 'fish'],
['print', 'berry', 'bird'],
['widow', 'bite', 'monkey'],
['date', 'alley', 'fold'],
['wagon', 'break', 'radio'],
['hound', 'pressure', 'shot'],
['coin', 'quick', 'spoon'],
['demon', 'limit', 'way'],
['broken', 'clear', 'eye'],
['pike', 'coat', 'signal'],
['lift', 'card', 'mask'],
['due', 'life', 'tense'],
['strike', 'same', 'tennis'],
['time', 'hair', 'stretch'],
['pine', 'crab', 'sauce'],
['speak', 'money', 'street'],
['mail', 'board', 'lung'],
['water', 'tobacco', 'stove'],
['tooth', 'potato', 'heart'],
['chest', 'car', 'store'],
['land', 'hand', 'house'],
['high', 'book', 'sour'],
['bump', 'egg', 'step']];

var wordTriads1Shuffled = Shuffle(wordTriads1);

// for (i=0; i < wordTriads1.length; i++){
//     wordTriads1Shuffled.push(Shuffle(wordTriads1[i]))
// };

var exampleTriads = [
    ['dew', 'comb', 'bee'],
['loser', 'throat', 'spot'],
['night', 'wrist', 'stop'],
['rocking', 'wheel', 'high']
];

var exampleTriadsAnswers = ['honey', 'sore', 'watch', 'horse'];


for (i=0; i < exampleTriads.length; i++){
    ratTrials.push({
      type: 'html-audio-response_modified',
    //   stimulus: `${wordTriadsShuffled[i][0]}, ${wordTriadsShuffled[i][1]}, ${wordTriadsShuffled[i][2]}`,
      stimulus: `This is a training trial. Find the 4th word that pairs with each of the 3 target words.<br><br>The words for this trial are:<br><br><br><b>${exampleTriads[i][0]}, ${exampleTriads[i][1]}, ${exampleTriads[i][2]}</b><br><br><br>`,
      buffer_length: 60000,
      allow_playback: true, // specifically to test if it's working, though double check this is okay.
      manually_end_recording_key: ['space'],
      stimulus_duration: 60000,
      wait_for_mic_approval: true,
      prompt: 'You will be able to replay your recording on these trials only.<br>'+ //
      'Please do so to make sure your audio is recording properly.<br>'+ //
      'If you finish early, press the spacebar to continue.',
      data: {exp: 'RAT',
        type: `RAT_example${i+1}`,
        words: [`${exampleTriads[i][0]}, ${exampleTriads[i][1]}, ${exampleTriads[i][2]}`]}
    })

    ratTrials.push({
      type: 'html-keyboard-response',
      stimulus: `The correct answer was: <b>${exampleTriadsAnswers[i]}`,
      choices: ['space'],
      prompt: "<p>Press spacebar to continue</p>",
      data: {exp: 'RAT',
        type: `RAT_example${i+1}_Answer`}
      })
};

var AC_RAT1 = {
  type: 'survey-multi-choice',
  questions: [
    {prompt: "On the final example trial page, which of the following words did you see?", options: ["moon","wheel", "day", "sore"], values: [0,1,0,0], required: true, horizontal: false, name: 'AC_RAT1'}
  ],
  data: {exp: 'RAT',
			type: "AC_RAT"}
};

ratTrials.push(AC_RAT1)

ratTrials.push({
type: 'html-keyboard-response',
stimulus: "Great! Now that you've got the hang of it, let's begin. You will no longer be shown the correct answer after each trial.<br>The first page will be another example. "+
"All pages to follow will be real trials!<br><br>When you're ready to begin, press the spacebar.",
choices: ['space'],
prompt: "",
data: {exp: 'RAT',
  type: 'RAT_Instr2'}
});

ratTrials.push({
      type: 'html-audio-response_modified',
      stimulus: `This is a training trial. Find the 4th word that pairs with each of the 3 target words.<br><br>The words for this trial are:<br><br><br><b>fountain, baking, pop</b><br><br><br>`,
      buffer_length: 180000,
      allow_playback: false,
      manually_end_recording_key: ['space'],
      stimulus_duration: 180000,
      wait_for_mic_approval: true,
      prompt: "When you're ready to begin the real trials, press the spacebar to continue.",
      data: {exp: 'RAT',
			type: "RAT_example5",
            words: 'fountain, baking, pop'}
    });

// for (i=0; i < wordTriads.length; i++){
for (i=0; i < wordTriads1Shuffled.length; i++){
    ratTrials.push({
      type: 'html-audio-response_modified',
      stimulus: 'Find the 4th word that pairs with each of the 3 target words below.<br><br>' + 
      `<b>${wordTriads1Shuffled[i][0]}, ${wordTriads1Shuffled[i][1]}, ${wordTriads1Shuffled[i][2]}</b><br><br><br>`,
    //   stimulus: `${wordTriads[i][0]}, ${wordTriads[i][1]}, ${wordTriads[i][2]}`,
      buffer_length: 60000,
      allow_playback: false,
      manually_end_recording_key: ['space'],
      stimulus_duration: 60000,
      wait_for_mic_approval: true,
      prompt: 'If you finish early, press the spacebar to continue.<br><br>',
      data: {exp: 'RAT',
        type: `RAT${i+1}`,
        words: [`${wordTriads1Shuffled[i][0]}, ${wordTriads1Shuffled[i][1]}, ${wordTriads1Shuffled[i][2]}`]}
    })
};

// RATs2
// RATs2
// RATs2
// RATs2
// RATs2
// RATs2
// RATs2
// RATs2
// RATs2

var wordTriads2 = [
    ['man', 'fox', 'peep'],
    ['flower', 'scout', 'friend'],
    ['cream', 'skate', 'water'],
    ['light', 'stick', 'birthday'],
    ['right', 'cat', 'carbon'],
    ['waffle', 'lung', 'tire'],
    ['wave', 'lamp', 'dry'],
    ['blanket', 'ball', 'house'],
    ['sore', 'shoulder', 'sweat'],
    ['note', 'dive', 'chair'],
    ['over', 'plant', 'horse'],
    ['reading', 'service', 'stick'],
    ['gear', 'hunter', 'hammer'],
    ['house', 'sandwich', 'golf'],
    ['cast', 'side', 'jump']
];


var wordTriads2Shuffled = Shuffle(wordTriads2);


for (i=0; i < wordTriads2Shuffled.length; i++){
    ratTrials.push({
      type: 'html-audio-response_modified',
      stimulus: 'Find the 4th word that pairs with each of the 3 target words below.<br><br>' + 
      `<b>${wordTriads2Shuffled[i][0]}, ${wordTriads2Shuffled[i][1]}, ${wordTriads2Shuffled[i][2]}</b><br><br><br>`,
    //   stimulus: `${wordTriads[i][0]}, ${wordTriads[i][1]}, ${wordTriads[i][2]}`,
      buffer_length: 60000,
      allow_playback: false,
      manually_end_recording_key: ['space'],
      stimulus_duration: 60000,
      wait_for_mic_approval: true,
      prompt: 'If you finish early, press the spacebar to continue.<br><br>',
      data: {exp: 'RAT',
        type: `RAT_set2_${i+1}`,
        words: [`${wordTriads2Shuffled[i][0]}, ${wordTriads2Shuffled[i][1]}, ${wordTriads2Shuffled[i][2]}`]}
    })
};

for(i=0; i < ratTrials.length; i++) {
    timeline.push(ratTrials[i])
}

// Demographics:

// var demographics = {
//   type: 'survey-multi-choice',
//   questions: [
//     {prompt: "<strong>Are you colorblind?</strong>", options: ["Yes, I am colorblind.","No, I am not colorblind"], values: ["Colorblind", "Not-Colorblind"], required: true, horizontal: false, name: 'Demo_Colorblind'}, 
//     {prompt: "<strong>What gender do you identify as?</strong>", options: ["Male", "Female", "Additional gender category/identity not listed", "Prefer not to answer"], values: ["Male", "Female", "Other", "No-Answer"], required: true, horizontal: false, name: 'Demo_Gender'},
//     {prompt: "<strong>What is your race/ethnicity?</strong>", options: ["Native American or Alaska Native", "Asian", "Pacific Islander", "Black or African American", "White", "Multi-racial / Multi-ethnic", "Other"], values: ["Native", "Asian", "Pacific-Islander", "Black", "White", "Multi", "Other"], required: true, horizontal: false, name: 'Demo_Race'},
//     {prompt: "<strong>Do you identify as Hispanic or Latino/a?</strong>", options: ["Yes, I identify as either Hispanic or Latino/a","No, I do not identify as either Hispanic or Latino/a"], values: ["Hispanic", "Not-Hispanic"], required: true, horizontal: false, name: 'Demo_Hispanic'}
//   ],
//   data: {exp: 'RAT',
// 			type: "demographics"}
// };

// timeline.push(demographics);

// var demographics2 = {
//   type: 'survey-text',
//   questions: [
//     {prompt: "What is your current age?", name: 'Age', rows: 1, columns: 2, required: true},
//     {prompt: "In your own words, please tell us about what you have seen, and what you had to do, in this study so far:", name: 'ParticipationSummary', rows: 10, columns: 70, required: true}, 
//     {prompt: "If you had to guess, what do you think this study was about?", name: 'MotivationGuess', rows: 10, columns: 70, required: true}, 
//     {prompt: "During your participation, did you encounter any issues or technical difficulties?", name: 'TechnicalIssues', rows: 10, columns: 70, required: true}
//   ],
//   data: {exp: 'RAT',
// 			type: "demographics2"}
// };

// timeline.push(demographics2);



var preloadImages = [];

jsPsych.data.addProperties({userAgent: navigator.userAgent,
	startTime: startTime,
	randCode: randCode
});

getPartID = function() {
  return JSON.parse(jsPsych.data.get().filter({type: 'partID'}).select('responses').values).partID
};

jsPsych.init({
      timeline: timeline,
      // preload_images: preloadImages,
	  show_progress_bar: true,
      on_finish: function () {
			var endTime = new Date();
			jsPsych.data.addProperties({endTime: endTime,
        partID: JSON.parse(jsPsych.data.get().filter({type: 'partID'}).select('responses').values).partID});
      // jsPsych.data.displayData();
			 SaveData(jsPsych.data.get().csv()); // .json()?
             SaveData(jsPsych.data.get().json()); // .json()?
    }
    });

    function SaveData(curData) {
  var dataToServer = {
    'id': getPartID(),
    'experimenter': 'Ethan',
    // 'experimentName': 'CogFlex_RAT_draft',
    'experimentName': 'RAT_Pilot_v3',
    'curData': curData
  }; 

  $.post("https://bradylab.ucsd.edu/turk/save.php",
    dataToServer,
    function(data) { 
			var newDoc = document.open("text/html", "replace");
			// newDoc.write("All done, thanks! To submit the HIT, paste this code into Turk: " + randCode);
            newDoc.write("Your responses have been recorded. You may now close this page. Thank you!");
			newDoc.close();
    }
  ).fail(function(data) { 
			var newDoc = document.open("text/html", "replace");
			// newDoc.write("All done, thanks! To submit the HIT, paste this code into Turk: " + randCode);
            newDoc.write("Your responses have been recorded. You may now close this page. Thank you!");
			newDoc.close();
	});  


  // $.post("http://localhost:8000/save.php",
  //   dataToServer,
  //   FunctionWhenDoneSaving
  // ).fail(FunctionWhenDoneSaving);
};

function FunctionWhenDoneSaving() {
        // var urlToRedirect = "https://ucsd.sona-systems.com/webstudy_credit.aspx?experiment_id=2079&credit_token=82002d4286dc4451a327871aa536edab&survey_code=" +
        // jsPsych.data.getURLVariable('survey_code');
    //    window.location.href = urlToRedirect;
      };

    </script>
  </body>
</html>
